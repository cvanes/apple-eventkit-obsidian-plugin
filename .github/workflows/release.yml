name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Bump version
        id: version
        run: |
          version=$(node -p "
            const pkg = require('./package.json');
            const [major, minor, patch] = pkg.version.split('.').map(Number);
            [major, minor, patch + 1].join('.');
          ")
          node -e "
            const fs = require('fs');
            for (const file of ['package.json', 'manifest.json']) {
              const data = JSON.parse(fs.readFileSync(file, 'utf8'));
              data.version = '${version}';
              fs.writeFileSync(file, JSON.stringify(data, null, 2) + '\n');
            }
            const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
            const versions = JSON.parse(fs.readFileSync('versions.json', 'utf8'));
            versions['${version}'] = manifest.minAppVersion;
            fs.writeFileSync('versions.json', JSON.stringify(versions, null, 2) + '\n');
          "
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json manifest.json versions.json
          git commit -m "chore: bump version to ${version}"
          git tag "${version}"
          git push origin main --tags
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Install npm dependencies
        run: npm ci

      - name: Build plugin
        run: npm run build

      - name: Build eventkitcli
        run: |
          cd eventkitcli
          swift build -c release --arch arm64
          swift build -c release --arch x86_64
          lipo -create \
            .build/arm64-apple-macosx/release/eventkitcli \
            .build/x86_64-apple-macosx/release/eventkitcli \
            -output eventkitcli-universal
          codesign --force --sign - --entitlements eventkitcli.entitlements eventkitcli-universal

      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          version="${{ steps.version.outputs.version }}"
          cp eventkitcli/eventkitcli-universal eventkitcli-bin
          gh release create "$version" \
            --title "$version" \
            --generate-notes \
            main.js \
            manifest.json \
            styles.css \
            eventkitcli-bin
